{
  "document": {
    "type": "product_requirements_document",
    "format_version": "2.0.0",
    "project_name": "actflower",
    "date": "2026-02-11",
    "status": "proposed",
    "supersedes": "PRD v1.0.0",
    "owners": [
      "actflower core team"
    ]
  },
  "intent": {
    "summary": "Deliver a methodologically stronger and computationally faster actflow system than ActflowToolbox by adding uncertainty-aware inference, leakage-proof evaluation, sparse noncircular execution, and fused kernels.",
    "positioning": "actflower should be both scientifically more defensible and computationally faster in realistic workloads."
  },
  "constraints": {
    "language": "R",
    "package_name": "actflower",
    "required_io": [
      "hdf5r"
    ],
    "required_neuro_stack": [
      "neuroim2"
    ],
    "forbidden_io": [
      "rhdf5"
    ],
    "platforms": [
      "macOS",
      "Linux"
    ]
  },
  "scope": {
    "in_scope": [
      "Uncertainty-aware actflow outputs (intervals and uncertainty summaries).",
      "Leakage-proof nested CV evaluation API with explicit split artifacts and deterministic reproducibility.",
      "Sparse/masked noncircular compute path for connectivity and activity pipelines.",
      "Fused native kernels for end-to-end throughput in high-volume evaluation paths."
    ],
    "out_of_scope": [
      "GUI products.",
      "Interactive notebook UI tooling.",
      "New modality support beyond current matrix/array workflows."
    ]
  },
  "personas": [
    {
      "name": "Methods Neuroscientist",
      "needs": [
        "Valid uncertainty statements, not only point estimates.",
        "Evaluation free of data leakage.",
        "Transparent reproducibility artifacts."
      ]
    },
    {
      "name": "Computational Engineer",
      "needs": [
        "Fast sparse execution for noncircular masks.",
        "Native paths that materially reduce runtime.",
        "Stable benchmark gates in CI."
      ]
    }
  ],
  "requirements": {
    "functional": [
      {
        "id": "FR-U1",
        "title": "Uncertainty-Aware Outputs",
        "requirement": "Provide uncertainty-aware summaries for actflow prediction and model comparison, including bootstrap confidence intervals and distributional summaries per metric."
      },
      {
        "id": "FR-U2",
        "title": "Uncertainty API",
        "requirement": "Expose a public API that returns point estimates, interval bounds, bootstrap draws metadata, and seed/config provenance."
      },
      {
        "id": "FR-E1",
        "title": "Leakage-Proof Nested CV",
        "requirement": "Provide a nested CV evaluation API with strict separation of outer test and inner model-selection data."
      },
      {
        "id": "FR-E2",
        "title": "Split Artifacts",
        "requirement": "Persist split indices, selected hyperparameters, and fold-level metrics for auditing."
      },
      {
        "id": "FR-S1",
        "title": "Sparse Noncircular FC",
        "requirement": "Support sparse/masked noncircular connectivity estimation without materializing dense intermediate matrices when mask density is low."
      },
      {
        "id": "FR-S2",
        "title": "Sparse Noncircular Activity",
        "requirement": "Support sparse/masked noncircular activity tensor generation with mask-aware write paths."
      },
      {
        "id": "FR-F1",
        "title": "Fused Native Kernel",
        "requirement": "Add fused native path for high-throughput evaluation (predict + metric aggregation) with parity to existing reference outputs."
      },
      {
        "id": "FR-F2",
        "title": "Dispatch Policy",
        "requirement": "Auto-select fused path when data shape and transfer mode are eligible; fallback to existing modular path otherwise."
      }
    ],
    "non_functional": [
      {
        "id": "NFR-CORRECT-1",
        "title": "Numerical Parity",
        "requirement": "New paths must match established reference behavior within strict tolerances."
      },
      {
        "id": "NFR-REPRO-1",
        "title": "Determinism",
        "requirement": "Fixed seeds produce reproducible CV splits and uncertainty outputs on same platform/dependency set."
      },
      {
        "id": "NFR-PERF-1",
        "title": "Performance Gateability",
        "requirement": "All new high-cost paths must be benchmarked and threshold-gated in CI."
      },
      {
        "id": "NFR-DX-1",
        "title": "Ergonomic API",
        "requirement": "APIs must return structured objects with explicit fields and actionable errors."
      }
    ]
  },
  "proposed_public_interfaces": [
    {
      "name": "actflow_uncertainty",
      "status": "new",
      "signature": "actflow_uncertainty(act_group, fc_group, metric = c(\"corr\", \"R2\", \"mae\"), n_boot = 1000, conf_level = 0.95, seed = NULL, parallel = FALSE, ...)",
      "returns": [
        "point",
        "interval",
        "distribution_summary",
        "bootstrap_config"
      ]
    },
    {
      "name": "actflow_nested_cv",
      "status": "new",
      "signature": "actflow_nested_cv(data, outer_folds = 5, inner_folds = 5, estimator_grid, seed = NULL, save_splits = TRUE, ...)",
      "returns": [
        "outer_metrics",
        "selected_hyperparams",
        "split_artifacts",
        "reproducibility_manifest"
      ]
    },
    {
      "name": "calcconn_parcelwise_noncircular",
      "status": "enhanced",
      "signature": "calcconn_parcelwise_noncircular(data, connmethod, parcelstoexclude_bytarget, sparse = TRUE, mask_format = c(\"list\", \"dgCMatrix\"), ...)",
      "returns": [
        "fc_matrix",
        "sparsity_stats"
      ]
    },
    {
      "name": "actflow_test",
      "status": "enhanced",
      "signature": "actflow_test(..., use_cpp = TRUE, use_fused = TRUE)",
      "returns": [
        "predicted",
        "metrics",
        "kernel_path"
      ]
    }
  ],
  "algorithmic_plan": [
    {
      "id": "ALG-U",
      "title": "Bootstrap Uncertainty Engine",
      "description": "Bootstrap over subjects and/or conditions with configurable resampling unit; return percentile and BCa intervals where applicable."
    },
    {
      "id": "ALG-E",
      "title": "Nested CV Contract",
      "description": "Explicit outer/inner split object; all hyperparameter decisions restricted to inner folds."
    },
    {
      "id": "ALG-S",
      "title": "Sparse Masked Computation",
      "description": "Represent masks with sparse structures and execute only non-zero source-target pairs for noncircular workflows."
    },
    {
      "id": "ALG-F",
      "title": "Fused Predict+Metric Kernel",
      "description": "Single native pass per subject block to compute predictions and summary metrics, minimizing memory traffic."
    }
  ],
  "acceptance_criteria": [
    {
      "id": "AC-U1",
      "category": "Uncertainty Correctness",
      "criterion": "Bootstrap intervals are generated and returned for configured metrics.",
      "verification": "Unit tests and integration tests for interval object shape/content.",
      "threshold": "100% of uncertainty-enabled tests pass; no missing interval fields."
    },
    {
      "id": "AC-U2",
      "category": "Uncertainty Calibration",
      "criterion": "Nominal 95% intervals show acceptable empirical coverage on synthetic linear benchmarks.",
      "verification": "Simulation test battery with known generating process.",
      "threshold": "Empirical coverage in [0.90, 0.98] for primary metrics."
    },
    {
      "id": "AC-E1",
      "category": "Leakage Prevention",
      "criterion": "Nested CV implementation prevents outer-test leakage during model selection.",
      "verification": "Adversarial leakage tests using sentinel features and controlled splits.",
      "threshold": "Leakage sentinel uplift <= 0.01 R2 relative to strict baseline."
    },
    {
      "id": "AC-E2",
      "category": "Nested CV Reproducibility",
      "criterion": "Split artifacts and selected hyperparameters are reproducible under fixed seed.",
      "verification": "Repeated runs with identical seed.",
      "threshold": "Bitwise-identical split artifacts and selected hyperparameters on same platform."
    },
    {
      "id": "AC-S1",
      "category": "Sparse Noncircular Correctness",
      "criterion": "Sparse noncircular path matches dense/reference outputs.",
      "verification": "Parity tests on synthetic masks and cross-language checks.",
      "threshold": "max_abs_err <= 1e-9; correlation >= 0.999999 for noncircular outputs."
    },
    {
      "id": "AC-S2",
      "category": "Sparse Noncircular Efficiency",
      "criterion": "Sparse path reduces cost at low mask density.",
      "verification": "Benchmark suite with density <= 10%.",
      "threshold": "Runtime speedup >= 1.5x and peak memory <= 0.6x of dense path."
    },
    {
      "id": "AC-F1",
      "category": "Fused Kernel Correctness",
      "criterion": "Fused kernel outputs match modular pipeline for eligible modes.",
      "verification": "Golden parity tests across dimensions and seeds.",
      "threshold": "max_abs_err <= 1e-10 on predicted values and metrics."
    },
    {
      "id": "AC-F2",
      "category": "Fused Kernel Performance",
      "criterion": "Fused path improves end-to-end throughput on benchmark profiles.",
      "verification": "CI benchmark profiles and local full profile.",
      "threshold": "Median runtime improvement >= 1.5x vs modular path."
    },
    {
      "id": "AC-P1",
      "category": "Cross-Language Parity",
      "criterion": "Cross-language benchmark includes core, combinedFC, and noncircular synthetic targets.",
      "verification": "Report + threshold checker in CI.",
      "threshold": "All configured parity and speed thresholds pass."
    },
    {
      "id": "AC-P2",
      "category": "Performance Targets",
      "criterion": "Performance thresholds are tightened while preserving stability.",
      "verification": "Threshold file and CI runs.",
      "threshold": "fc_corr speedup floor >= 0.12; multreg/prediction floors remain >= existing strict levels."
    }
  ],
  "benchmarking_and_ci": {
    "required_workflows": [
      ".github/workflows/benchmark-gate.yaml",
      ".github/workflows/crosslang-benchmark.yaml"
    ],
    "required_artifacts": [
      "benchmark report JSON",
      "R timings JSON",
      "Python timings JSON"
    ],
    "threshold_files": [
      "tools/benchmark_thresholds.json",
      "tools/benchmark_r_vs_python_thresholds.json"
    ]
  },
  "milestones": [
    {
      "id": "M1",
      "name": "Uncertainty + Nested CV Core",
      "exit_criteria": [
        "AC-U1",
        "AC-U2",
        "AC-E1",
        "AC-E2"
      ]
    },
    {
      "id": "M2",
      "name": "Sparse Noncircular + Fused Kernel",
      "exit_criteria": [
        "AC-S1",
        "AC-S2",
        "AC-F1",
        "AC-F2"
      ]
    },
    {
      "id": "M3",
      "name": "CI Gated Release Candidate",
      "exit_criteria": [
        "AC-P1",
        "AC-P2"
      ]
    }
  ],
  "risks": [
    {
      "id": "R1",
      "risk": "Fused kernels can reduce readability and increase debugging complexity.",
      "mitigation": "Maintain modular reference path and strict parity tests."
    },
    {
      "id": "R2",
      "risk": "Cross-platform BLAS variability can destabilize performance gates.",
      "mitigation": "Pin CI benchmark profiles and thread settings; use conservative floors."
    },
    {
      "id": "R3",
      "risk": "Bootstrap runtime costs may be high for large datasets.",
      "mitigation": "Parallel option, early diagnostics, and recommended default resample counts."
    }
  ]
}
