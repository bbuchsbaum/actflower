name: crosslang-benchmark

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"
  pull_request:

jobs:
  crosslang:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install numpy h5py scikit-learn

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y libhdf5-dev

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::Rcpp
            any::RcppArmadillo
            any::hdf5r
            any::jsonlite
            any::testthat
            any::devtools
            any::remotes
          needs: check

      - name: Install neuroim2
        run: |
          Rscript -e "remotes::install_github('bbuchsbaum/neuroim2', upgrade = 'never', dependencies = FALSE)"

      - name: Install actflower
        run: R CMD INSTALL .

      - name: Run cross-language benchmark
        run: |
          python tools/benchmark_r_vs_python.py \
            --nodes 60 \
            --timepoints 200 \
            --conditions 10 \
            --subjects 4 \
            --repeats 2 \
            --include-combined \
            --report-json inst/extdata/benchmarks/r_vs_python/report_ci.json

      - name: Check benchmark thresholds
        run: |
          python tools/check_r_vs_python_report.py \
            --report inst/extdata/benchmarks/r_vs_python/report_ci.json \
            --thresholds tools/benchmark_r_vs_python_thresholds.json

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: crosslang-benchmark
          path: |
            inst/extdata/benchmarks/r_vs_python/report_ci.json
            inst/extdata/benchmarks/r_vs_python/python_timings.json
            inst/extdata/benchmarks/r_vs_python/r_timings.json
